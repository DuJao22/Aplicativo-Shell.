import { VolumetricTable } from './types';

/**
 * Standard Cylinder Generator
 * Used for fuels where we don't have exact table data, estimating based on capacity.
 * Now returns 1 decimal place precision.
 */
const generateCylinderData = (diameter: number, length: number): VolumetricTable => {
  const table: VolumetricTable = {};
  const radius = diameter / 2;
  const totalSteps = 261; // Extended to support up to 260 for safety

  const volumeMap = new Map<number, number>();

  for (let h = 0; h <= 260; h++) {
    let vol = 0;
    if (h <= 0) vol = 0;
    else if (h >= diameter) vol = Math.PI * Math.pow(radius, 2) * length;
    else {
      const term1 = Math.pow(radius, 2) * Math.acos((radius - h) / radius);
      const term2 = (radius - h) * Math.sqrt(2 * radius * h - Math.pow(h, 2));
      vol = length * (term1 - term2);
    }
    // Round to 1 decimal place: (Vol in cm3 / 1000) * 10 -> Round -> / 10
    volumeMap.set(h, Math.round(vol / 100) / 10);
  }

  for (let i = 0; i < totalSteps; i += 10) {
    const row: number[] = [];
    for (let j = 0; j < 10; j++) {
      const h = i + j;
      row.push(h > 260 ? (volumeMap.get(260) || 0) : (volumeMap.get(h) || 0));
    }
    table[i] = row;
  }
  return table;
};

/**
 * Helper to interpolate missing values using anchors and cylinder theory
 */
const interpolateFromAnchors = (
  diameter: number, 
  length: number, 
  anchors: Record<number, number>
): VolumetricTable => {
  const table: VolumetricTable = {};
  const radius = diameter / 2;
  const sortedAnchorKeys = Object.keys(anchors).map(Number).sort((a, b) => a - b);
  const maxAnchor = sortedAnchorKeys[sortedAnchorKeys.length - 1];

  const getCylinderVolume = (h: number) => {
    if (h <= 0) return 0;
    if (h >= diameter) return Math.PI * Math.pow(radius, 2) * length / 1000;
    const term1 = Math.pow(radius, 2) * Math.acos((radius - h) / radius);
    const term2 = (radius - h) * Math.sqrt(2 * radius * h - Math.pow(h, 2));
    return length * (term1 - term2) / 1000;
  };

  const volumeMap = new Map<number, number>();

  // Determine max height to generate based on anchors (handling tables > 250cm)
  const maxGenHeight = Math.max(260, maxAnchor);

  for (let h = 0; h <= maxGenHeight; h++) {
    if (anchors[h] !== undefined) {
      volumeMap.set(h, anchors[h]);
      continue;
    }

    let lowerH = 0;
    let upperH = 260;

    for (let i = 0; i < sortedAnchorKeys.length; i++) {
      if (sortedAnchorKeys[i] < h) lowerH = sortedAnchorKeys[i];
      if (sortedAnchorKeys[i] > h) {
        upperH = sortedAnchorKeys[i];
        break;
      }
    }

    if (h > maxAnchor) {
      lowerH = maxAnchor;
      upperH = maxAnchor; // Cap at max known
    }

    const volCyl = getCylinderVolume(h);
    const volCylLower = getCylinderVolume(lowerH);
    const volCylUpper = getCylinderVolume(upperH || 260);

    const volTableLower = anchors[lowerH];
    
    const ratioLower = (volCylLower > 0) ? volTableLower / volCylLower : 1;
    let ratioUpper = 1.0;
    
    if (anchors[upperH] !== undefined) {
        ratioUpper = anchors[upperH] / volCylUpper;
    } else {
        ratioUpper = ratioLower; 
    }

    const t = (upperH === lowerH) ? 0 : (h - lowerH) / (upperH - lowerH);
    const interpolatedRatio = ratioLower + t * (ratioUpper - ratioLower);
    const finalVol = volCyl * interpolatedRatio;
    
    volumeMap.set(h, Math.round(finalVol * 10) / 10);
  }

  // Populate volumetric table structure (0-9, 10-19, etc)
  const rowsNeeded = Math.ceil((maxGenHeight + 1) / 10) * 10;
  for (let i = 0; i < rowsNeeded; i += 10) {
    const row: number[] = [];
    for (let j = 0; j < 10; j++) {
      const h = i + j;
      const val = volumeMap.get(h);
      // If val is undefined (e.g. h > maxGen), repeat last known value
      row.push(val !== undefined ? val : (volumeMap.get(maxGenHeight) || 0));
    }
    table[i] = row;
  }

  return table;
}

/**
 * Specialized Generator for Gasolina (V1)
 * Updated with user provided calibration data (H, V_Parcial_V1).
 * Data Range: 1cm to 254cm
 */
const generateGasolinaData = (): VolumetricTable => {
  const diameter = 250;
  const length = 209.5; 

  // Exact values from new calibration table
  const anchors: Record<number, number> = {
    1: 8.9, 2: 25.2, 3: 46.2, 4: 71.0, 5: 99.1, 6: 130.2, 7: 165.1, 8: 195.6, 9: 228.4, 10: 268.3,
    11: 310.3, 12: 354.2, 13: 399.8, 14: 447.2, 15: 496.3, 16: 546.9, 17: 599.0, 18: 652.7, 19: 707.7, 20: 749.9,
    21: 807.2, 22: 866.0, 23: 925.9, 24: 987.0, 25: 1049.4, 26: 1112.8, 27: 1177.4, 28: 1243.1, 29: 1309.8, 30: 1377.5,
    31: 1446.2, 32: 1516.0, 33: 1586.9, 34: 1640.3, 35: 1712.6, 36: 1785.7, 37: 1859.8, 38: 1934.7, 39: 2010.5, 40: 2087.0,
    41: 2164.4, 42: 2242.5, 43: 2321.5, 44: 2401.1, 45: 2481.5, 46: 2542.3, 47: 2623.9, 48: 2706.2, 49: 2789.2, 50: 2877.8,
    51: 2957.1, 52: 3042.1, 53: 3127.6, 54: 3213.8, 55: 3300.6, 56: 3387.9, 57: 3475.8, 58: 3564.3, 59: 3631.0, 60: 3720.5,
    61: 3810.4, 62: 3900.9, 63: 3991.9, 64: 4083.4, 65: 4175.3, 66: 4267.8, 67: 4360.7, 68: 4454.1, 69: 4547.9, 70: 4642.1,
    71: 4736.8, 72: 4808.1, 73: 4903.5, 74: 4999.3, 75: 5095.4, 76: 5192.0, 77: 5289.0, 78: 5386.3, 79: 5484.0, 80: 5582.0,
    81: 5680.4, 82: 5779.1, 83: 5878.0, 84: 5977.2, 85: 6076.8, 86: 6151.9, 87: 6252.1, 88: 6352.5, 89: 6453.2, 90: 6554.2,
    91: 6655.4, 92: 6756.9, 93: 6858.6, 94: 6960.6, 95: 7062.8, 96: 7165.2, 97: 7267.8, 98: 7344.9, 99: 7447.9, 100: 7551.1,
    101: 7654.5, 102: 7758.0, 103: 7861.8, 104: 7965.7, 105: 8069.7, 106: 8173.9, 107: 8278.3, 108: 8382.7, 109: 8487.4, 110: 8592.1,
    111: 8670.7, 112: 8775.6, 113: 8880.7, 114: 8985.9, 115: 9091.1, 116: 9196.4, 117: 9301.8, 118: 9407.2, 119: 9512.7, 120: 9618.3,
    121: 9723.9, 122: 9829.6, 123: 9935.3, 124: 10041.0, 125: 10120.3, 126: 10226.1, 127: 10331.8, 128: 10437.7, 129: 10543.4, 130: 10649.2,
    131: 10755.0, 132: 10860.7, 133: 10966.4, 134: 11072.1, 135: 11177.6, 136: 11283.2, 137: 11382.3, 138: 11467.7, 139: 11573.2, 140: 11678.5,
    141: 11783.7, 142: 11888.8, 143: 11993.9, 144: 12098.8, 145: 12203.6, 146: 12308.3, 147: 12412.9, 148: 12517.4, 149: 12617.7, 150: 12711.7,
    151: 12805.9, 152: 12907.8, 153: 13011.5, 154: 13115.0, 155: 13218.4, 156: 13321.6, 157: 13424.6, 158: 13527.4, 159: 13630.0, 160: 13732.3,
    161: 13834.5, 162: 13936.4, 163: 14012.7, 164: 14114.2, 165: 14215.4, 166: 14316.3, 167: 14417.0, 168: 14517.5, 169: 14617.7, 170: 14717.5,
    171: 14817.0, 172: 14916.3, 173: 15015.2, 174: 15113.8, 175: 15212.1, 176: 15285.6, 177: 15383.2, 178: 15480.5, 179: 15577.5, 180: 15674.1,
    181: 15770.2, 182: 15866.0, 183: 15961.4, 184: 16056.4, 185: 16151.0, 186: 16245.1, 187: 16338.8, 188: 16432.1, 189: 16501.7, 190: 16594.2,
    191: 16686.1, 192: 16777.6, 193: 16868.6, 194: 16959.1, 195: 17049.1, 196: 17138.5, 197: 17227.4, 198: 17315.7, 199: 17403.5, 200: 17490.7,
    201: 17577.3, 202: 17641.9, 203: 17727.4, 204: 17812.4, 205: 17896.7, 206: 17980.3, 207: 18063.3, 208: 18145.6, 209: 18227.3, 210: 18308.2,
    211: 18388.4, 212: 18467.8, 213: 18546.4, 214: 18624.3, 215: 18701.3, 216: 18777.5, 217: 18834.0, 218: 18927.3, 219: 19011.2, 220: 19049.8,
    221: 19129.2, 222: 19200.9, 223: 19271.1, 224: 19340.5, 225: 19408.3, 226: 19474.6, 227: 19543.0, 228: 19608.4, 229: 19656.7, 230: 19720.2,
    231: 19782.5, 232: 19843.8, 233: 19903.6, 234: 19962.3, 235: 20019.7, 236: 20075.7, 237: 20130.4, 238: 20183.7, 239: 20235.4, 240: 20285.7,
    241: 20334.3, 242: 20369.7, 243: 20415.4, 244: 20459.2, 245: 20501.2, 246: 20541.1, 247: 20578.9, 248: 20614.4, 249: 20647.4, 250: 20677.7,
    251: 20705.1, 252: 20729.0, 253: 20748.9, 254: 20748.9
  };

  return interpolateFromAnchors(diameter, length, anchors);
};

/**
 * Specialized Generator for Diesel S10 (V1/V3)
 * Mapped to the user's provided Diesel table image (Column V1/V3).
 */
const generateDieselData = (): VolumetricTable => {
  const diameter = 250;
  const length = 209.5; 

  // Values from user's provided full CSV-style list
  const anchors: Record<number, number> = {
    1: 4.5, 2: 12.8, 3: 23.5, 4: 36.1, 5: 50.4, 6: 66.2, 7: 78.9, 8: 97.0, 9: 116.2, 10: 136.5,
    11: 157.8, 12: 180.1, 13: 203.3, 14: 227.5, 15: 252.4, 16: 278.1, 17: 304.7, 18: 331.9, 19: 359.9, 20: 381.4,
    21: 410.8, 22: 440.4, 23: 470.9, 24: 502.0, 25: 533.7, 26: 566.0, 27: 598.8, 28: 632.2, 29: 666.1, 30: 700.6,
    31: 735.6, 32: 771.0, 33: 797.9, 34: 834.2, 35: 871.0, 36: 908.2, 37: 945.9, 38: 984.0, 39: 1022.5, 40: 1061.5,
    41: 1100.8, 42: 1140.6, 43: 1180.7, 44: 1221.2, 45: 1262.1, 46: 1293.0, 47: 1334.5, 48: 1376.4, 49: 1418.6, 50: 1461.1,
    51: 1504.0, 52: 1547.2, 53: 1590.7, 54: 1634.5, 55: 1678.7, 56: 1723.1, 57: 1767.8, 58: 1812.8, 59: 1846.7, 60: 1892.2,
    61: 1938.0, 62: 1984.0, 63: 2030.3, 64: 2076.8, 65: 2123.6, 66: 2170.6, 67: 2217.9, 68: 2285.3, 69: 2313.1, 70: 2361.0,
    71: 2409.1, 72: 2445.4, 73: 2493.9, 74: 2542.6, 75: 2591.5, 76: 2640.7, 77: 2690.0, 78: 2739.5, 79: 2789.1, 80: 2839.0,
    81: 2889.0, 82: 2939.2, 83: 2989.6, 84: 3040.1, 85: 3078.1, 86: 3128.8, 87: 3179.8, 88: 3230.9, 89: 3282.1, 90: 3333.4,
    91: 3384.9, 92: 3436.5, 93: 3488.3, 94: 3540.1, 95: 3592.1, 96: 3644.2, 97: 3696.4, 98: 3735.6, 99: 3788.0, 100: 3840.5,
    101: 3893.1, 102: 3945.7, 103: 3998.5, 104: 4051.3, 105: 4104.3, 106: 4157.2, 107: 4210.3, 108: 4263.5, 109: 4316.7, 110: 4369.9,
    111: 4409.9, 112: 4463.3, 113: 4516.7, 114: 4570.1, 115: 4623.7, 116: 4677.3, 117: 4730.9, 118: 4784.5, 119: 4838.1, 120: 4891.8,
    121: 4945.6, 122: 4999.3, 123: 5053.1, 124: 5093.4, 125: 5147.2, 126: 5201.0, 127: 5254.8, 128: 5308.6, 129: 5362.4, 130: 5416.2,
    131: 5470.0, 132: 5523.7, 133: 5577.5, 134: 5631.2, 135: 5684.9, 136: 5738.6, 137: 5778.9, 138: 5832.5, 139: 5886.1, 140: 5939.7,
    141: 5993.2, 142: 6046.7, 143: 6100.1, 144: 6153.4, 145: 6206.8, 146: 6260.0, 147: 6313.2, 148: 6366.3, 149: 6419.4, 150: 6459.1,
    151: 6512.0, 152: 6564.9, 153: 6617.6, 154: 6670.3, 155: 6722.9, 156: 6775.3, 157: 6827.7, 158: 6880.0, 159: 6932.2, 160: 6984.3,
    161: 7036.2, 162: 7088.0, 163: 7126.8, 164: 7178.4, 165: 7229.9, 166: 7281.3, 167: 7332.5, 168: 7383.6, 169: 7434.5, 170: 7485.3,
    171: 7535.9, 172: 7586.4, 173: 7636.7, 174: 7686.9, 175: 7736.8, 176: 7774.2, 177: 7823.9, 178: 7873.4, 179: 7922.7, 180: 7971.8,
    181: 8020.7, 182: 8069.4, 183: 8118.0, 184: 8166.3, 185: 8214.4, 186: 8262.2, 187: 8309.9, 188: 8357.3, 189: 8392.8, 190: 8439.8,
    191: 8486.6, 192: 8533.1, 193: 8579.3, 194: 8625.4, 195: 8671.1, 196: 8716.6, 197: 8761.8, 198: 8806.8, 199: 8851.4, 200: 8895.8,
    201: 8939.8, 202: 8983.5, 203: 9026.8, 204: 9069.8, 205: 9102.2, 206: 9144.8, 207: 9187.0, 208: 9228.9, 209: 9270.4, 210: 9311.5,
    211: 9352.3, 212: 9392.7, 213: 9432.8, 214: 9472.4, 215: 9511.7, 216: 9540.8, 217: 9579.4, 218: 9617.5, 219: 9655.1, 220: 9692.3,
    221: 9729.1, 222: 9765.4, 223: 9801.2, 224: 9836.6, 225: 9871.4, 226: 9905.8, 227: 9939.6, 228: 9972.8, 229: 9997.4, 230: 10029.7,
    231: 10061.4, 232: 10092.5, 233: 10122.9, 234: 10152.8, 235: 10182.0, 236: 10210.5, 237: 10238.3, 238: 10265.4, 239: 10291.7, 240: 10317.3,
    241: 10342.0, 242: 10360.0, 243: 10383.2, 244: 10405.5, 245: 10426.9, 246: 10447.2, 247: 10466.4, 248: 10484.5, 249: 10501.2, 250: 10516.7,
    251: 10530.6, 252: 10542.7, 253: 10552.9, 254: 10533.9
  };

  return interpolateFromAnchors(diameter, length, anchors);
};

// --- DATA EXPORTS ---

/**
 * EXACT DATA TABLE FOR ADITIVADOS
 * Based on user-provided full CSV.
 */
const ADITIVADO_DATA_RAW: VolumetricTable = {
  0:   [0, 7, 18, 34, 52, 72, 95, 120, 146, 174],
  10:  [204, 235, 267, 301, 336, 372, 409, 448, 487, 528],
  20:  [569, 612, 655, 699, 744, 790, 837, 885, 933, 983],
  30:  [1032, 1083, 1135, 1187, 1239, 1293, 1347, 1401, 1457, 1513],
  40:  [1569, 1626, 1684, 1742, 1801, 1860, 1920, 1980, 2041, 2102],
  50:  [2164, 2226, 2289, 2352, 2416, 2480, 2544, 2609, 2674, 2740],
  60:  [2806, 2872, 2939, 3006, 3074, 3142, 3210, 3278, 3347, 3416],
  70:  [3486, 3556, 3626, 3696, 3767, 3838, 3909, 3981, 4053, 4125],
  80:  [4197, 4270, 4342, 4415, 4489, 4562, 4636, 4710, 4784, 4858],
  90:  [4933, 5007, 5082, 5157, 5233, 5308, 5384, 5459, 5535, 5611],
  100: [5687, 5764, 5840, 5917, 5993, 6070, 6147, 6224, 6301, 6378],
  110: [6456, 6533, 6610, 6688, 6765, 6843, 6921, 6999, 7076, 7154],
  120: [7232, 7310, 7388, 7466, 7544, 7622, 7700, 7778, 7856, 7934],
  130: [8012, 8090, 8168, 8246, 8324, 8402, 8480, 8558, 8636, 8714],
  140: [8791, 8869, 8947, 9024, 9102, 9179, 9256, 9333, 9410, 9487],
  150: [9564, 9641, 9718, 9794, 9871, 9947, 10023, 10099, 10175, 10251],
  160: [10326, 10402, 10477, 10552, 10627, 10701, 10776, 10850, 10924, 10998],
  170: [11072, 11145, 11219, 11292, 11364, 11437, 11509, 11581, 11653, 11725],
  180: [11796, 11867, 11937, 12008, 12078, 12148, 12217, 12286, 12355, 12424],
  190: [12492, 12560, 12627, 12694, 12761, 12828, 12894, 12959, 13024, 13089],
  200: [13154, 13218, 13281, 13344, 13407, 13469, 13531, 13592, 13653, 13713],
  210: [13773, 13832, 13890, 13949, 14006, 14063, 14120, 14175, 14231, 14285],
  220: [14339, 14393, 14445, 14497, 14549, 14599, 14649, 14698, 14747, 14794],
  230: [14841, 14887, 14932, 14976, 15019, 15062, 15103, 15144, 15183, 15221],
  240: [15258, 15294, 15329, 15363, 15395, 15426, 15455, 15483, 15510, 15534],
  250: [15556, 15577, 15595, 15610, 15621, 0, 0, 0, 0, 0] // 255-259 are n/a
};

/**
 * EXACT DATA TABLE FOR ETANOL COMUM
 * Based on user-provided full CSV.
 */
const ETANOL_COMUM_DATA_RAW: VolumetricTable = {
  0:   [0, 13, 37, 68, 104, 145, 191, 240, 293, 349],
  10:  [408, 470, 535, 603, 673, 745, 820, 897, 976, 1058],
  20:  [1141, 1226, 1313, 1401, 1492, 1584, 1678, 1774, 1871, 1969],
  30:  [2069, 2171, 2274, 2378, 2484, 2591, 2699, 2809, 2920, 3032],
  40:  [3145, 3259, 3375, 3491, 3609, 3728, 3848, 3969, 4090, 4213],
  50:  [4337, 4462, 4587, 4714, 4841, 4970, 5099, 5229, 5359, 5491],
  60:  [5623, 5757, 5890, 6025, 6160, 6296, 6433, 6570, 6709, 6847],
  70:  [6987, 7127, 7267, 7408, 7550, 7692, 7835, 7979, 8122, 8267],
  80:  [8412, 8557, 8703, 8850, 8996, 9144, 9291, 9440, 9588, 9737],
  90:  [9886, 10036, 10186, 10337, 10488, 10639, 10790, 10942, 11094, 11246],
  100: [11399, 11552, 11705, 11858, 12012, 12166, 12320, 12474, 12629, 12784],
  110: [12938, 13094, 13249, 13404, 13560, 13715, 13871, 14027, 14183, 14339],
  120: [14495, 14651, 14807, 14964, 15120, 15277, 15433, 15589, 15746, 15902],
  130: [16059, 16215, 16372, 16528, 16684, 16840, 16996, 17152, 17308, 17464],
  140: [17620, 17776, 17931, 18086, 18242, 18397, 18552, 18706, 18861, 19015],
  150: [19169, 19323, 19477, 19630, 19783, 19936, 20089, 20241, 20393, 20545],
  160: [20696, 20847, 20998, 21148, 21298, 21448, 21597, 21746, 21895, 22043],
  170: [22191, 22338, 22485, 22631, 22777, 22922, 23067, 23212, 23356, 23499],
  180: [23642, 23784, 23926, 24067, 24207, 24347, 24486, 24625, 24763, 24900],
  190: [25037, 25173, 25308, 25443, 25577, 25710, 25842, 25973, 26104, 26234],
  200: [26363, 26491, 26618, 26745, 26870, 26995, 27119, 27241, 27363, 27484],
  210: [27604, 27722, 27840, 27956, 28072, 28186, 28299, 28411, 28522, 28631],
  220: [28740, 28846, 28952, 29056, 29159, 29260, 29360, 29459, 29556, 29651],
  230: [29745, 29837, 29927, 30016, 30103, 30187, 30270, 30351, 30430, 30507],
  240: [30582, 30654, 30724, 30791, 30856, 30918, 30976, 31032, 31085, 31134],
  250: [31179, 31220, 31255, 31286, 31309, 0, 0, 0, 0, 0] 
};

// Diesel: Uses new anchor points from user image
export const DIESEL_TABLE: VolumetricTable = generateDieselData();

// Gasolina: ~20,000L - Highly Tuned to V1 Column using Anchors
export const GASOLINA_TABLE: VolumetricTable = generateGasolinaData();

// Etanol Comum: Uses provided table (0-254cm)
export const ETANOL_COMUM_TABLE: VolumetricTable = ETANOL_COMUM_DATA_RAW;

// Etanol Aditivado: Uses provided table (0-254cm)
export const ETANOL_ADITIVADO_TABLE: VolumetricTable = ADITIVADO_DATA_RAW;

// Gasolina Aditivada: Uses provided table (0-254cm)
export const GASOLINA_ADITIVADO_TABLE: VolumetricTable = ADITIVADO_DATA_RAW;