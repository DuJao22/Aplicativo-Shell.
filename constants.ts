import { VolumetricTable } from './types';

/**
 * Standard Cylinder Generator
 * Used for fuels where we don't have exact table data, estimating based on capacity.
 * Now returns 1 decimal place precision.
 */
const generateCylinderData = (diameter: number, length: number): VolumetricTable => {
  const table: VolumetricTable = {};
  const radius = diameter / 2;
  const totalSteps = 261; // Extended to support up to 260 for safety

  const volumeMap = new Map<number, number>();

  for (let h = 0; h <= 260; h++) {
    let vol = 0;
    if (h <= 0) vol = 0;
    else if (h >= diameter) vol = Math.PI * Math.pow(radius, 2) * length;
    else {
      const term1 = Math.pow(radius, 2) * Math.acos((radius - h) / radius);
      const term2 = (radius - h) * Math.sqrt(2 * radius * h - Math.pow(h, 2));
      vol = length * (term1 - term2);
    }
    // Round to 1 decimal place: (Vol in cm3 / 1000) * 10 -> Round -> / 10
    volumeMap.set(h, Math.round(vol / 100) / 10);
  }

  for (let i = 0; i < totalSteps; i += 10) {
    const row: number[] = [];
    for (let j = 0; j < 10; j++) {
      const h = i + j;
      row.push(h > 260 ? (volumeMap.get(260) || 0) : (volumeMap.get(h) || 0));
    }
    table[i] = row;
  }
  return table;
};

/**
 * Helper to interpolate missing values using anchors and cylinder theory
 */
const interpolateFromAnchors = (
  diameter: number, 
  length: number, 
  anchors: Record<number, number>
): VolumetricTable => {
  const table: VolumetricTable = {};
  const radius = diameter / 2;
  const sortedAnchorKeys = Object.keys(anchors).map(Number).sort((a, b) => a - b);
  const maxAnchor = sortedAnchorKeys[sortedAnchorKeys.length - 1];

  const getCylinderVolume = (h: number) => {
    if (h <= 0) return 0;
    if (h >= diameter) return Math.PI * Math.pow(radius, 2) * length / 1000;
    const term1 = Math.pow(radius, 2) * Math.acos((radius - h) / radius);
    const term2 = (radius - h) * Math.sqrt(2 * radius * h - Math.pow(h, 2));
    return length * (term1 - term2) / 1000;
  };

  const volumeMap = new Map<number, number>();

  // Determine max height to generate based on anchors (handling tables > 250cm)
  const maxGenHeight = Math.max(260, maxAnchor);

  for (let h = 0; h <= maxGenHeight; h++) {
    if (anchors[h] !== undefined) {
      volumeMap.set(h, anchors[h]);
      continue;
    }

    let lowerH = 0;
    let upperH = 260;

    for (let i = 0; i < sortedAnchorKeys.length; i++) {
      if (sortedAnchorKeys[i] < h) lowerH = sortedAnchorKeys[i];
      if (sortedAnchorKeys[i] > h) {
        upperH = sortedAnchorKeys[i];
        break;
      }
    }

    if (h > maxAnchor) {
      lowerH = maxAnchor;
      upperH = maxAnchor; // Cap at max known
    }

    const volCyl = getCylinderVolume(h);
    const volCylLower = getCylinderVolume(lowerH);
    const volCylUpper = getCylinderVolume(upperH || 260);

    const volTableLower = anchors[lowerH];
    
    const ratioLower = (volCylLower > 0) ? volTableLower / volCylLower : 1;
    let ratioUpper = 1.0;
    
    if (anchors[upperH] !== undefined) {
        ratioUpper = anchors[upperH] / volCylUpper;
    } else {
        ratioUpper = ratioLower; 
    }

    const t = (upperH === lowerH) ? 0 : (h - lowerH) / (upperH - lowerH);
    const interpolatedRatio = ratioLower + t * (ratioUpper - ratioLower);
    const finalVol = volCyl * interpolatedRatio;
    
    volumeMap.set(h, Math.round(finalVol * 10) / 10);
  }

  // Populate volumetric table structure (0-9, 10-19, etc)
  const rowsNeeded = Math.ceil((maxGenHeight + 1) / 10) * 10;
  for (let i = 0; i < rowsNeeded; i += 10) {
    const row: number[] = [];
    for (let j = 0; j < 10; j++) {
      const h = i + j;
      const val = volumeMap.get(h);
      // If val is undefined (e.g. h > maxGen), repeat last known value
      row.push(val !== undefined ? val : (volumeMap.get(maxGenHeight) || 0));
    }
    table[i] = row;
  }

  return table;
}

/**
 * Specialized Generator for Gasolina (V1)
 * Full dataset mapped exactly to the user's provided complete table.
 */
const generateGasolinaData = (): VolumetricTable => {
  const diameter = 250;
  const length = 411.85; 

  const anchors: Record<number, number> = {
    1: 8.9, 2: 25.2, 3: 46.2, 4: 71.0, 5: 99.1,
    6: 130.2, 7: 165.1, 8: 195.6, 9: 228.4, 10: 268.3,
    11: 310.3, 12: 354.2, 13: 399.8, 14: 447.2, 15: 496.3,
    16: 546.9, 17: 599.0, 18: 652.7, 19: 707.7, 20: 749.9,
    21: 807.2, 22: 866.0, 23: 925.9, 24: 987.0, 25: 1049.4,
    26: 1112.8, 27: 1177.4, 28: 1243.1, 29: 1309.8, 30: 1377.5,
    31: 1446.2, 32: 1516.0, 33: 1586.9, 34: 1640.3, 35: 1712.6,
    36: 1785.7, 37: 1859.8, 38: 1934.7, 39: 2010.5, 40: 2087.0,
    41: 2164.4, 42: 2242.5, 43: 2321.5, 44: 2401.1, 45: 2481.5,
    46: 2542.3, 47: 2623.9, 48: 2706.2, 49: 2789.2, 50: 2877.8,
    51: 2957.1, 52: 3042.1, 53: 3127.6, 54: 3213.8, 55: 3300.6,
    56: 3387.9, 57: 3475.8, 58: 3564.3, 59: 3631.0, 60: 3720.5,
    61: 3810.4, 62: 3900.9, 63: 3991.9, 64: 4083.4, 65: 4175.3,
    66: 4267.8, 67: 4360.7, 68: 4454.1, 69: 4547.9, 70: 4642.1,
    71: 4736.8, 72: 4808.1, 73: 4903.5, 74: 4999.3, 75: 5095.4,
    76: 5192.0, 77: 5289.0, 78: 5386.3, 79: 5484.0, 80: 5582.0,
    81: 5680.4, 82: 5779.1, 83: 5878.0, 84: 5977.2, 85: 6076.8,
    86: 6151.9, 87: 6252.1, 88: 6352.5, 89: 6453.2, 90: 6554.2,
    91: 6655.4, 92: 6756.9, 93: 6858.6, 94: 6960.6, 95: 7062.8,
    96: 7165.2, 97: 7267.8, 98: 7344.9, 99: 7447.9, 100: 7551.1,
    101: 7654.5, 102: 7758.0, 103: 7861.8, 104: 7965.7, 105: 8069.7,
    106: 8173.9, 107: 8278.3, 108: 8382.7, 109: 8487.4, 110: 8592.1,
    111: 8670.7, 112: 8775.6, 113: 8880.7, 114: 8985.9, 115: 9091.1,
    116: 9196.4, 117: 9301.8, 118: 9407.2, 119: 9512.7, 120: 9618.3,
    121: 9723.9, 122: 9829.6, 123: 9935.3, 124: 10041.0, 125: 10120.3,
    126: 10226.1, 127: 10331.8, 128: 10437.7, 129: 10543.4, 130: 10649.2,
    131: 10755.0, 132: 10860.7, 133: 10966.4, 134: 11072.1, 135: 11177.6,
    136: 11283.2, 137: 11382.3, 138: 11467.7, 139: 11573.2, 140: 11678.5,
    141: 11783.7, 142: 11888.8, 143: 11993.9, 144: 12098.8, 145: 12203.6,
    146: 12308.3, 147: 12412.9, 148: 12517.4, 149: 12617.7, 150: 12711.7,
    151: 12805.9, 152: 12907.8, 153: 13011.5, 154: 13115.0, 155: 13218.4,
    156: 13321.6, 157: 13424.6, 158: 13527.4, 159: 13630.0, 160: 13732.3,
    161: 13834.5, 162: 13936.4, 163: 14012.7, 164: 14114.2, 165: 14215.4,
    166: 14316.3, 167: 14417.0, 168: 14517.5, 169: 14617.7, 170: 14717.5,
    171: 14817.0, 172: 14916.3, 173: 15015.2, 174: 15113.8, 175: 15212.1,
    176: 15285.6, 177: 15383.2, 178: 15480.5, 179: 15577.5, 180: 15674.1,
    181: 15770.2, 182: 15866.0, 183: 15961.4, 184: 16056.4, 185: 16151.0,
    186: 16245.1, 187: 16338.8, 188: 16432.1, 189: 16501.7, 190: 16594.2,
    191: 16686.1, 192: 16777.6, 193: 16868.6, 194: 16959.1, 195: 17049.1,
    196: 17138.5, 197: 17227.4, 198: 17315.7, 199: 17403.5, 200: 17490.7,
    201: 17577.3, 202: 17641.9, 203: 17727.4, 204: 17812.4, 205: 17896.7,
    206: 17980.3, 207: 18063.3, 208: 18145.6, 209: 18227.3, 210: 18308.2,
    211: 18388.4, 212: 18467.8, 213: 18546.4, 214: 18624.3, 215: 18701.3,
    216: 18777.5, 217: 18834.0, 218: 18927.3, 219: 19011.2, 220: 19049.8,
    221: 19129.2, 222: 19200.9, 223: 19271.1, 224: 19340.5, 225: 19408.3,
    226: 19474.6, 227: 19543.0, 228: 19608.4, 229: 19656.7, 230: 19720.2,
    231: 19782.5, 232: 19843.8, 233: 19903.6, 234: 19962.3, 235: 20019.7,
    236: 20075.7, 237: 20130.4, 238: 20183.7, 239: 20235.4, 240: 20285.7,
    241: 20334.3, 242: 20369.7, 243: 20415.4, 244: 20459.2, 245: 20501.2,
    246: 20541.1, 247: 20578.9, 248: 20614.4, 249: 20647.4, 250: 20677.7,
    251: 20705.1, 252: 20729.0, 253: 20748.9, 254: 20748.9
  };
  
  return interpolateFromAnchors(diameter, length, anchors);
};

/**
 * Specialized Generator for Diesel S10 (V1/V3)
 * Mapped to the user's provided Diesel table image (Column V1/V3).
 */
const generateDieselData = (): VolumetricTable => {
  const diameter = 250;
  const length = 209.5; 

  // Values from user's provided full CSV-style list
  const anchors: Record<number, number> = {
    1: 4.5, 2: 12.8, 3: 23.5, 4: 36.1, 5: 50.4, 6: 66.2, 7: 78.9, 8: 97.0, 9: 116.2, 10: 136.5,
    11: 157.8, 12: 180.1, 13: 203.3, 14: 227.5, 15: 252.4, 16: 278.1, 17: 304.7, 18: 331.9, 19: 359.9, 20: 381.4,
    21: 410.6, 22: 440.4, 23: 470.9, 24: 502.0, 25: 533.7, 26: 566.0, 27: 598.8, 28: 632.2, 29: 666.1, 30: 700.6,
    31: 735.6, 32: 771.0, 33: 797.9, 34: 834.2, 35: 871.0, 36: 908.2, 37: 945.9, 38: 984.0, 39: 1022.5, 40: 1061.5,
    41: 1100.8, 42: 1140.6, 43: 1180.7, 44: 1221.2, 45: 1262.1, 46: 1293.0, 47: 1334.5, 48: 1376.4, 49: 1418.6, 50: 1461.1,
    51: 1504.0, 52: 1547.2, 53: 1590.7, 54: 1634.5, 55: 1678.7, 56: 1723.1, 57: 1767.8, 58: 1812.8, 59: 1846.7, 60: 1892.2,
    61: 1938.0, 62: 1984.0, 63: 2030.3, 64: 2076.8, 65: 2123.6, 66: 2170.8, 67: 2217.9, 68: 2265.3, 69: 2313.1, 70: 2361.0,
    71: 2409.1, 72: 2445.4, 73: 2493.9, 74: 2542.6, 75: 2591.5, 76: 2640.7, 77: 2690.0, 78: 2739.5, 79: 2789.1, 80: 2839.0,
    81: 2889.0, 82: 2939.2, 83: 2989.6, 84: 3040.1, 85: 3078.1, 86: 3128.8, 87: 3179.8, 88: 3230.9, 89: 3282.1, 90: 3333.4,
    91: 3384.9, 92: 3436.5, 93: 3488.3, 94: 3540.1, 95: 3592.1, 96: 3644.2, 97: 3696.4, 98: 3735.6, 99: 3788.0, 100: 3840.5,
    101: 3893.1, 102: 3945.7, 103: 3998.5, 104: 4051.3, 105: 4104.3, 106: 4157.2, 107: 4210.3, 108: 4263.5, 109: 4316.7, 110: 4369.9,
    111: 4409.9, 112: 4463.3, 113: 4516.7, 114: 4570.1, 115: 4623.7, 116: 4677.3, 117: 4730.9, 118: 4784.5, 119: 4838.1, 120: 4891.8,
    121: 4945.6, 122: 4999.3, 123: 5053.1, 124: 5093.4, 125: 5147.2, 126: 5201.0, 127: 5254.8, 128: 5308.6, 129: 5362.4, 130: 5416.2,
    131: 5470.0, 132: 5523.7, 133: 5577.5, 134: 5631.2, 135: 5684.9, 136: 5738.6, 137: 5778.9, 138: 5832.5, 139: 5886.1, 140: 5939.7,
    141: 5993.2, 142: 6046.7, 143: 6100.1, 144: 6153.4, 145: 6206.8, 146: 6260.0, 147: 6313.2, 148: 6366.3, 149: 6419.4, 150: 6459.1,
    151: 6512.0, 152: 6564.9, 153: 6617.6, 154: 6670.3, 155: 6722.9, 156: 6775.3, 157: 6827.7, 158: 6880.0, 159: 6932.2, 160: 6984.3,
    161: 7036.2, 162: 7088.0, 163: 7126.8, 164: 7178.4, 165: 7229.9, 166: 7281.3, 167: 7332.5, 168: 7383.6, 169: 7434.5, 170: 7485.3,
    171: 7535.9, 172: 7586.4, 173: 7636.7, 174: 7686.9, 175: 7736.8, 176: 7774.2, 177: 7823.9, 178: 7873.4, 179: 7922.7, 180: 7971.8,
    181: 8020.7, 182: 8069.4, 183: 8118.0, 184: 8166.2, 185: 8214.4, 186: 8262.2, 187: 8309.9, 188: 8357.3, 189: 8392.8, 190: 8439.8,
    191: 8486.6, 192: 8533.1, 193: 8579.3, 194: 8625.4, 195: 8671.1, 196: 8716.6, 197: 8761.8, 198: 8806.8, 199: 8851.4, 200: 8895.8,
    201: 8939.8, 202: 8972.7, 203: 9016.2, 204: 9059.4, 205: 9102.2, 206: 9144.8, 207: 9187.0, 208: 9228.9, 209: 9270.4, 210: 9311.5,
    211: 9352.3, 212: 9392.7, 213: 9432.8, 214: 9472.4, 215: 9511.7, 216: 9540.8, 217: 9579.4, 218: 9617.5, 219: 9655.1, 220: 9692.3,
    221: 9729.1, 222: 9765.4, 223: 9801.2, 224: 9836.6, 225: 9871.4, 226: 9905.8, 227: 9939.6, 228: 9972.8, 229: 9997.4, 230: 10029.7,
    231: 10061.4, 232: 10092.5, 233: 10122.9, 234: 10152.8, 235: 10182.0, 236: 10210.5, 237: 10238.3, 238: 10265.4, 239: 10291.7, 240: 10317.3,
    241: 10342.0, 242: 10366.0, 243: 10383.2, 244: 10405.5, 245: 10426.9, 246: 10447.2, 247: 10466.4, 248: 10484.5, 249: 10501.2, 250: 10516.7,
    251: 10530.6, 252: 10542.7, 253: 10552.9, 254: 10533.9
  };

  return interpolateFromAnchors(diameter, length, anchors);
};

/**
 * Specialized Generator for Aditivados (Gasolina Aditivada & Etanol Aditivado)
 * Covers range 1cm to 259cm
 */
const generateAditivadoData = (): VolumetricTable => {
  const diameter = 250;
  // Length is inferred/interpolated by the helper but this dataset is full so length param is just fallback
  const length = 209.5; 

  const anchors: Record<number, number> = {
    1: 7, 2: 18, 3: 34, 4: 52, 5: 72, 6: 95, 7: 120, 8: 146, 9: 174, 10: 204,
    11: 235, 12: 267, 13: 301, 14: 336, 15: 372, 16: 409, 17: 448, 18: 487, 19: 528, 20: 569,
    21: 612, 22: 655, 23: 699, 24: 744, 25: 790, 26: 837, 27: 885, 28: 933, 29: 983, 30: 1032,
    31: 1083, 32: 1135, 33: 1187, 34: 1239, 35: 1293, 36: 1347, 37: 1401, 38: 1457, 39: 1513, 40: 1569,
    41: 1626, 42: 1684, 43: 1742, 44: 1801, 45: 1860, 46: 1920, 47: 1980, 48: 2041, 49: 2102, 50: 2164,
    51: 2226, 52: 2289, 53: 2352, 54: 2416, 55: 2480, 56: 2544, 57: 2609, 58: 2674, 59: 2740, 60: 2806,
    61: 2872, 62: 2939, 63: 3006, 64: 3074, 65: 3142, 66: 3210, 67: 3278, 68: 3347, 69: 3416, 70: 3486,
    71: 3556, 72: 3626, 73: 3696, 74: 3767, 75: 3838, 76: 3909, 77: 3981, 78: 4053, 79: 4125, 80: 4197,
    81: 4270, 82: 4342, 83: 4415, 84: 4489, 85: 4562, 86: 4636, 87: 4710, 88: 4784, 89: 4858, 90: 4933,
    91: 5007, 92: 5082, 93: 5157, 94: 5233, 95: 5308, 96: 5384, 97: 5459, 98: 5535, 99: 5611, 100: 5687,
    101: 5764, 102: 5840, 103: 5917, 104: 5993, 105: 6070, 106: 6147, 107: 6224, 108: 6301, 109: 6378, 110: 6456,
    111: 6533, 112: 6610, 113: 6688, 114: 6765, 115: 6843, 116: 6921, 117: 6999, 118: 7076, 119: 7154, 120: 7232,
    121: 7310, 122: 7388, 123: 7466, 124: 7544, 125: 7622, 126: 7700, 127: 7778, 128: 7856, 129: 7934, 130: 8012,
    131: 8090, 132: 8168, 133: 8246, 134: 8324, 135: 8402, 136: 8480, 137: 8558, 138: 8636, 139: 8714, 140: 8791,
    141: 8869, 142: 8947, 143: 9024, 144: 9102, 145: 9179, 146: 9256, 147: 9333, 148: 9410, 149: 9487, 150: 9564,
    151: 9641, 152: 9718, 153: 9794, 154: 9871, 155: 9947, 156: 10023, 157: 10099, 158: 10175, 159: 10251, 160: 10326,
    161: 10402, 162: 10477, 163: 10552, 164: 10627, 165: 10701, 166: 10776, 167: 10850, 168: 10924, 169: 10998, 170: 11072,
    171: 11145, 172: 11219, 173: 11292, 174: 11364, 175: 11437, 176: 11509, 177: 11581, 178: 11653, 179: 11725, 180: 11796,
    181: 11867, 182: 11937, 183: 12008, 184: 12078, 185: 12148, 186: 12217, 187: 12286, 188: 12355, 189: 12424, 190: 12492,
    191: 12560, 192: 12627, 193: 12694, 194: 12761, 195: 12828, 196: 12894, 197: 12959, 198: 13024, 199: 13089, 200: 13154,
    201: 13218, 202: 13281, 203: 13344, 204: 13407, 205: 13469, 206: 13531, 207: 13592, 208: 13653, 209: 13713, 210: 13773,
    211: 13832, 212: 13890, 213: 13949, 214: 14006, 215: 14063, 216: 14120, 217: 14175, 218: 14231, 219: 14285, 220: 14339,
    221: 14393, 222: 14445, 223: 14497, 224: 14549, 225: 14599, 226: 14649, 227: 14698, 228: 14747, 229: 14794, 230: 14841,
    231: 14887, 232: 14932, 233: 14976, 234: 15019, 235: 15062, 236: 15103, 237: 15144, 238: 15183, 239: 15221, 240: 15258,
    241: 15294, 242: 15329, 243: 15363, 244: 15395, 245: 15426, 246: 15455, 247: 15483, 248: 15510, 249: 15534, 250: 15556,
    251: 15577, 252: 15595, 253: 15610, 254: 15621, 255: 15632, 256: 15643, 257: 15654, 258: 15665, 259: 15676
  };
  
  return interpolateFromAnchors(diameter, length, anchors);
}

// --- DATA EXPORTS ---

// Diesel: Uses new anchor points from user image
export const DIESEL_TABLE: VolumetricTable = generateDieselData();

// Gasolina: ~20,000L - Highly Tuned to V1 Column using Anchors
export const GASOLINA_TABLE: VolumetricTable = generateGasolinaData();

// Etanol Comum: ~15,000L (Generic approximation)
export const ETANOL_COMUM_TABLE: VolumetricTable = generateCylinderData(250, 305);

// Etanol Aditivado: Uses provided table (1-259cm)
export const ETANOL_ADITIVADO_TABLE: VolumetricTable = generateAditivadoData();

// Gasolina Aditivada: Uses provided table (1-259cm)
export const GASOLINA_ADITIVADO_TABLE: VolumetricTable = generateAditivadoData();